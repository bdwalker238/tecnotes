<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pgbackrest with Azure Storage Account | Brian Walker's tecnotes</title><meta name=keywords content><meta name=description content="Using pgbackrest with Azure Storage Account
This article shows you how to setup pgbackrest to use a azure storage account.
Steps
1) Create Storage Account
First you need to setup a Azure Storage Account, either using Terraform, ARM Template Azure Cli, or via Azure Portal.
Mandatory settings for the Azure Storage Account.
Resouce Group - Name of your resource group.


Storage Account Name - Name of storage account.


Region -  Your deployment Region.


Primary Service -  Azure Blob Storage or Azure Data Lake Storage Gen 2.


Enable Storage account key access."><meta name=author content><link rel=canonical href=https://bdwalk.onrender.com/posts/postgres_0882025_post1/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://bdwalk.onrender.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bdwalk.onrender.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bdwalk.onrender.com/favicon-32x32.png><link rel=apple-touch-icon href=https://bdwalk.onrender.com/apple-touch-icon.png><link rel=mask-icon href=https://bdwalk.onrender.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bdwalk.onrender.com/posts/postgres_0882025_post1/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://bdwalk.onrender.com/posts/postgres_0882025_post1/"><meta property="og:site_name" content="Brian Walker's tecnotes"><meta property="og:title" content="Pgbackrest with Azure Storage Account"><meta property="og:description" content="Using pgbackrest with Azure Storage Account This article shows you how to setup pgbackrest to use a azure storage account.
Steps 1) Create Storage Account First you need to setup a Azure Storage Account, either using Terraform, ARM Template Azure Cli, or via Azure Portal.
Mandatory settings for the Azure Storage Account.
Resouce Group - Name of your resource group. Storage Account Name - Name of storage account. Region - Your deployment Region. Primary Service - Azure Blob Storage or Azure Data Lake Storage Gen 2. Enable Storage account key access."><meta property="og:locale" content="en-uk"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-09T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pgbackrest with Azure Storage Account"><meta name=twitter:description content="Using pgbackrest with Azure Storage Account
This article shows you how to setup pgbackrest to use a azure storage account.
Steps
1) Create Storage Account
First you need to setup a Azure Storage Account, either using Terraform, ARM Template Azure Cli, or via Azure Portal.
Mandatory settings for the Azure Storage Account.
Resouce Group - Name of your resource group.


Storage Account Name - Name of storage account.


Region -  Your deployment Region.


Primary Service -  Azure Blob Storage or Azure Data Lake Storage Gen 2.


Enable Storage account key access."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bdwalk.onrender.com/posts/"},{"@type":"ListItem","position":2,"name":"Pgbackrest with Azure Storage Account","item":"https://bdwalk.onrender.com/posts/postgres_0882025_post1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pgbackrest with Azure Storage Account","name":"Pgbackrest with Azure Storage Account","description":"Using pgbackrest with Azure Storage Account This article shows you how to setup pgbackrest to use a azure storage account.\nSteps 1) Create Storage Account First you need to setup a Azure Storage Account, either using Terraform, ARM Template Azure Cli, or via Azure Portal.\nMandatory settings for the Azure Storage Account.\nResouce Group - Name of your resource group. Storage Account Name - Name of storage account. Region - Your deployment Region. Primary Service - Azure Blob Storage or Azure Data Lake Storage Gen 2. Enable Storage account key access.\n","keywords":[],"articleBody":"Using pgbackrest with Azure Storage Account This article shows you how to setup pgbackrest to use a azure storage account.\nSteps 1) Create Storage Account First you need to setup a Azure Storage Account, either using Terraform, ARM Template Azure Cli, or via Azure Portal.\nMandatory settings for the Azure Storage Account.\nResouce Group - Name of your resource group. Storage Account Name - Name of storage account. Region - Your deployment Region. Primary Service - Azure Blob Storage or Azure Data Lake Storage Gen 2. Enable Storage account key access.\nOptional settings for the Azure Storage Account.\nPerformance - Standard or Premium. Redundancy - Align your organisation RPO and RTO requiements. Networking - Align to your organisation network policy , probably a private end point. Access tier - Hot/Cool/Cold. Hot is a practical choice if you conistently restoring a production backup to uat once a week!\nTip - I would keep your storage account in a different azure resource group to your postgres VM’s, so if you accidently delete the Postgres resource group + VMS your backup data is seperated. Plus if you kept your Storage Account in same Azure Resource group that manages your Recovery Services vault(s), your backup data is in one place.\nOnce the Storage Account created, obtain a storage details ; account name, container name, endpoint address.\nIn your pgbackrest.conf file , add\n[global] repo1-type=azure repo1-azure-account=storage account name repo1-azure-container=storage account container name repo1-azure-endpoint=Storage account endpoint address repo1-azure-key= Storage account key repo1-azure-key-type=shared repo1-path=/storage account container name start-fast=y repo1-retention-full=retention value log-level-console=info log-level-file=detail link-all=y archive-async=y archive-copy=y archive-check=y process-max=4 archive-push-queue-max = 2GB spool-path = /var/spool/pgbackrest/14 archive-get-queue-max = 2GB [sname] pg1-path=PGDATA Dir pg1-port=PG PORT\nThen pgbackrest stanza-create –config pgbackrest.conf –stanza=sname –log-level-console=info pgbackrest –stanza=sname –log-level-console=debug check pgbackrest –stanza=sname –type=full backup\nsname = Stanza name\npsql # To test archive\nselect pg_switch_wal(); select pg_switch_wal();\nCheck your Postgres log file for errors.\nStop Postgres to test a restore\nDelete your Cluster\npgbackrest –stanza=sname –type=immediate –log-level-console=debug restore –link-all Start Postgres Check postgres log file for any errors, and ‘Execute pg_wal_replay_resume() to promote’ If you have recommendation to promote issue -\nhostname $ psql select pg_wal_replay_resume();\nAny Best Pratices Always have a dedicated spool path , and use archive-async so if there is any delay /error with your Storage account files can be temporary archive to the spool directory, and reduce risk of fill up your primary wal directory! Why Use Azure Storage Accounts Azure Storage accounts are ideal for backup data when hosting Postgres in Azure, as backup data is backed up directly to different infrastructure, and can be geo-replicated. Azure Storage accounts only charge you for , Volume of data stored per month + Quantity and types of operations performed, along with any data transfer costs + Data redundancy option selected. Whereas, using azure managed disk for backups + archives charge - disk type, disk size ( Not volume of backup data), LRS/ZRS, and typical to meet backup protection requirements would need to be disk snapshoted or backuped up by Recovery Services vault. So directly managed disks you pay twice. ","wordCount":"507","inLanguage":"en","datePublished":"2025-08-09T00:00:00Z","dateModified":"2025-08-09T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://bdwalk.onrender.com/posts/postgres_0882025_post1/"},"publisher":{"@type":"Organization","name":"Brian Walker's tecnotes","logo":{"@type":"ImageObject","url":"https://bdwalk.onrender.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bdwalk.onrender.com/ accesskey=h title="Brian Walker's tecnotes (Alt + H)">Brian Walker's tecnotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bdwalk.onrender.com/ title=Home><span>Home</span></a></li><li><a href=https://bdwalk.onrender.com/posts title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Pgbackrest with Azure Storage Account</h1><div class=post-meta><span title='2025-08-09 00:00:00 +0000 UTC'>August 9, 2025</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#using-pgbackrest-with-azure-storage-account aria-label="Using pgbackrest with Azure Storage Account">Using pgbackrest with Azure Storage Account</a></li><li><a href=#steps aria-label=Steps>Steps</a><ul><ul><ul><ul><li><a href=#1-create-storage-account aria-label="1) Create Storage Account">1) Create Storage Account</a></li></ul></ul></ul></ul></li></ul><li><a href=#pgbackrest-stanzasname-typeimmediate--log-level-consoledebug-restore-link-all aria-label="pgbackrest &ndash;stanza=sname &ndash;type=immediate  &ndash;log-level-console=debug restore &ndash;link-all">pgbackrest &ndash;stanza=sname &ndash;type=immediate &ndash;log-level-console=debug restore &ndash;link-all</a></li><li><a href=#start-postgres aria-label="Start Postgres">Start Postgres</a></li><li><a href=#check-postgres-log-file-for-any-errors-and-execute-pg_wal_replay_resume-to-promote-if-you-have aria-label="Check postgres log file for any errors, and &lsquo;Execute pg_wal_replay_resume() to promote&rsquo; If you have">Check postgres log file for any errors, and &lsquo;Execute pg_wal_replay_resume() to promote&rsquo; If you have</a><ul><li><a href=#any-best-pratices aria-label="Any Best Pratices">Any Best Pratices</a></li><li><a href=#why-use-azure-storage-accounts aria-label="Why Use Azure Storage Accounts">Why Use Azure Storage Accounts</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=using-pgbackrest-with-azure-storage-account>Using pgbackrest with Azure Storage Account<a hidden class=anchor aria-hidden=true href=#using-pgbackrest-with-azure-storage-account>#</a></h2><p>This article shows you how to setup pgbackrest to use a azure storage account.</p><h2 id=steps>Steps<a hidden class=anchor aria-hidden=true href=#steps>#</a></h2><h6 id=1-create-storage-account>1) Create Storage Account<a hidden class=anchor aria-hidden=true href=#1-create-storage-account>#</a></h6><p>First you need to setup a Azure Storage Account, either using Terraform, ARM Template Azure Cli, or via Azure Portal.</p><p>Mandatory settings for the Azure Storage Account.</p><p>Resouce Group - Name of your resource group.<br>Storage Account Name - Name of storage account.<br>Region - Your deployment Region.<br>Primary Service - Azure Blob Storage or Azure Data Lake Storage Gen 2.<br>Enable Storage account key access.</p><p>Optional settings for the Azure Storage Account.</p><p>Performance - Standard or Premium.<br>Redundancy - Align your organisation RPO and RTO requiements.<br>Networking - Align to your organisation network policy , probably a private end point.<br>Access tier - Hot/Cool/Cold. Hot is a practical choice if you conistently restoring a production backup to uat once a week!</p><p>Tip - I would keep your storage account in a different azure resource group to your postgres VM&rsquo;s,
so if you accidently delete the Postgres resource group + VMS your backup data is seperated. Plus if you kept
your Storage Account in same Azure Resource group that manages your Recovery Services vault(s), your backup data is in one place.</p><ol start=2><li><p>Once the Storage Account created, obtain a storage details ; account name, container name, endpoint address.</p></li><li><p>In your pgbackrest.conf file , add</p></li></ol><p>[global]
repo1-type=azure
repo1-azure-account=storage account name
repo1-azure-container=storage account container name
repo1-azure-endpoint=Storage account endpoint address
repo1-azure-key= Storage account key
repo1-azure-key-type=shared
repo1-path=/storage account container name
start-fast=y
repo1-retention-full=retention value
log-level-console=info
log-level-file=detail
link-all=y
archive-async=y
archive-copy=y
archive-check=y
process-max=4
archive-push-queue-max = 2GB
spool-path = /var/spool/pgbackrest/14
archive-get-queue-max = 2GB
[sname]
pg1-path=PGDATA Dir
pg1-port=PG PORT</p><ol start=4><li>Then</li></ol><p>pgbackrest stanza-create &ndash;config pgbackrest.conf &ndash;stanza=sname –log-level-console=info
pgbackrest &ndash;stanza=sname &ndash;log-level-console=debug check
pgbackrest &ndash;stanza=sname &ndash;type=full backup</p><p>sname = Stanza name</p><p>psql # To test archive</p><p>select pg_switch_wal(); select pg_switch_wal();</p><p>Check your Postgres log file for errors.</p><p>Stop Postgres to test a restore</p><p>Delete your Cluster</p><h1 id=pgbackrest-stanzasname-typeimmediate--log-level-consoledebug-restore-link-all>pgbackrest &ndash;stanza=sname &ndash;type=immediate &ndash;log-level-console=debug restore &ndash;link-all<a hidden class=anchor aria-hidden=true href=#pgbackrest-stanzasname-typeimmediate--log-level-consoledebug-restore-link-all>#</a></h1><h1 id=start-postgres>Start Postgres<a hidden class=anchor aria-hidden=true href=#start-postgres>#</a></h1><h1 id=check-postgres-log-file-for-any-errors-and-execute-pg_wal_replay_resume-to-promote-if-you-have>Check postgres log file for any errors, and &lsquo;Execute pg_wal_replay_resume() to promote&rsquo; If you have<a hidden class=anchor aria-hidden=true href=#check-postgres-log-file-for-any-errors-and-execute-pg_wal_replay_resume-to-promote-if-you-have>#</a></h1><p>recommendation to promote issue -</p><p>hostname $ psql
select pg_wal_replay_resume();</p><h2 id=any-best-pratices>Any Best Pratices<a hidden class=anchor aria-hidden=true href=#any-best-pratices>#</a></h2><ul><li>Always have a dedicated spool path , and use archive-async so if there is any delay /error with your Storage account
files can be temporary archive to the spool directory, and reduce risk of fill up your primary wal directory!</li></ul><h2 id=why-use-azure-storage-accounts>Why Use Azure Storage Accounts<a hidden class=anchor aria-hidden=true href=#why-use-azure-storage-accounts>#</a></h2><ul><li>Azure Storage accounts are ideal for backup data when hosting Postgres in Azure, as backup data is backed up directly
to different infrastructure, and can be geo-replicated.</li><li>Azure Storage accounts only charge you for , Volume of data stored per month + Quantity and types of operations performed, along with any data transfer costs + Data redundancy option selected. Whereas, using azure managed disk for backups + archives charge - disk type, disk size ( Not volume of backup data), LRS/ZRS, and typical to meet backup protection requirements would need to be disk snapshoted or backuped up by Recovery Services vault. So directly managed disks you pay twice.</li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://bdwalk.onrender.com/>Brian Walker's tecnotes</a></span> ·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>